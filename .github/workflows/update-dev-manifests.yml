name: Auto-Update Development Environment

on:
  workflow_run:
    workflows: ["Build and Deploy Windows ASP.NET to ACR"]
    types:
      - completed
    branches: [ main ]

permissions:
  contents: write

env:
  REGISTRY_NAME: acrdemoeastus2001
  IMAGE_NAME: windows-aspnet

jobs:
  auto-update-development:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: 'Get workflow run info'
      id: workflow-info
      run: |
        # Get the commit SHA from the triggering workflow
        COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
        echo "commit-sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

    - name: 'Checkout repository'
      uses: actions/checkout@v4
      with:
        ref: main
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: 'Setup Kustomize'
      run: |
        # Use direct binary download to avoid GitHub rate limiting
        KUSTOMIZE_VERSION="v5.3.0"
        wget -O kustomize.tar.gz "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KUSTOMIZE_VERSION}/kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
        tar -xzf kustomize.tar.gz
        chmod +x kustomize
        sudo mv kustomize /usr/local/bin/
        kustomize version

    - name: 'Update development environment with retry logic'
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions"
        
        # Function to attempt update with retry
        attempt_update() {
          local max_retries=3
          local retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1)) of $max_retries"
            
            # Ensure we're up to date
            git checkout main
            git pull origin main
            
            # Update the image tag (stay in root directory)
            cd environments/development
            kustomize edit set image ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.workflow-info.outputs.commit-sha }}
            cd ../..
            
            echo "Updated development environment with image: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.workflow-info.outputs.commit-sha }}"
            
            # Check if there are changes to commit (now from root directory)
            git add environments/development/
            
            if git diff --staged --quiet; then
              echo "No changes to commit - development environment already up to date"
              return 0
            fi
            
            # Commit the changes
            git commit -m "üöÄ Auto-update development environment to ${{ steps.workflow-info.outputs.commit-sha }}
            
            - Updated by: GitHub Actions (Auto-deployment)
            - Triggering workflow: ${{ github.event.workflow_run.name }}
            - Run ID: ${{ github.event.workflow_run.id }}
            - Image: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.workflow-info.outputs.commit-sha }}
            
            This commit triggers ArgoCD to automatically sync the development environment."
            
            # Try to push
            if git push origin main; then
              echo "‚úÖ Successfully updated development environment manifest"
              return 0
            else
              echo "‚ö†Ô∏è  Push failed, retrying in 5 seconds..."
              sleep 5
              retry_count=$((retry_count + 1))
              
              # Reset to clean state for next attempt
              git reset --hard HEAD~1
            fi
          done
          
          echo "‚ùå Failed to push after $max_retries attempts"
          return 1
        }
        
        # Execute the update with retry logic
        attempt_update